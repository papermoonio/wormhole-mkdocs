# Scripts for Autogenerating Documentation Content

This directory holds the tooling that keeps the docs in sync with the latest Wormhole chain data. Running the scripts will:

- Pull fresh metadata from the Wormhole SDK (via the exported `getContracts` helper).
- Fetch curated raw contract lists from GitHub (as configured in `src/config/product-support-config.json`) to capture details missing from the SDK.
- Regenerate reusable HTML/markdown tables (contracts, chain IDs, product support, governance, etc.).
- Inject the new content between matching `<!--TAG--> ... <!--TAG-->` markers inside `wormhole-docs/.snippets/text`.

Day-to-day operators do not need to touch the TypeScript—just run `npm run update` followed by `npm run generate` inside this directory.

## Prerequisites

- Node.js **18+** (matches the mkdocs toolchain).
- This repo checked out with **`wormhole-docs` cloned alongside it** (`wormhole-mkdocs/wormhole-docs`).
- Network access for fetching contract constants from the Wormhole SDK (unless you point to local files).
- Optional environment variable: `DOCS_SNIPPETS_DIR` to override the default snippets path (`../wormhole-docs/.snippets/text`).
- Notion credentials (required for executor-style contract tables):
  - `NOTION_API_KEY`
  - Use environment variables `NOTION_CONTRACTS_MAINNET_DB_ID` / `NOTION_CONTRACTS_TESTNET_DB_ID` **or** populate `src/config/notion-database-ids.json` with your database IDs.
  - Optional: `NOTION_VERSION` (defaults to `2022-06-28`)

## Quick Start

1. `cd scripts`
2. `npm run update`
   - Installs/refreshes dependencies so the generator uses the latest SDK and helpers.
3. `npm run generate`
   - Pulls contract data, regenerates JSON, and rewrites snippets. Watch for unmatched-tag warnings.
4. Review and commit changes in both `scripts/` and `wormhole-docs/.snippets/text`.
5. Open two PRs: one targeting `wormhole-mkdocs` for the mkdocs updates and another targeting `wormhole` if that repo picked up changes; make sure each PR links to the other.

(Optional) Run `npm run typecheck` if you modified the scripts or need extra confidence.

## Project Layout

| Path                                         | What it does                                                                                                         |
|----------------------------------------------|----------------------------------------------------------------------------------------------------------------------|
| `package.json` / `package-lock.json`         | Node project config and dependency lockfile.                                                                         |
| `tsconfig.json`                              | TypeScript compiler settings used by `npm run typecheck`.                                                            |
| `src/index.ts`                               | Main entrypoint invoked by `npm run generate`; orchestrates chain gathering and snippet updates via the tag manager. |
| `src/fetchAllProductChains.ts`               | Pre-step that generates `src/generated/*.json` based on `product-support-config.json`.                               |
| `src/generateProductSupport.ts`              | Parses SDK constants (local or remote), applies filters/overrides, and writes sorted product-support JSON.           |
| `src/generated/*`                            | Autogenerated support matrices plus `index.ts` that re-exports them. Commit these when they change.                  |
| `src/config.ts`                              | Builds the master list of doc chains from the SDK, merges local metadata, and persists updated `src/chains/*.json`.  |
| `src/details.ts`                             | Renders HTML tables for contracts, chain IDs, consistency levels, supported networks, and faucets.                   |
| `src/governance.ts`                          | Fetches governance contract data (EVM + Solana) using URLs from `config/contracts-config.json` and turns it into HTML. |
| `src/util.ts`                                | Shared formatting helpers (table builder, indentation, sorting).                                                     |
| `src/notion/client.ts`                       | Minimal Notion API wrapper that handles auth, versioning, and pagination.                                            |
| `src/notion/parser.ts`                       | Extracts chain names and contract addresses from Notion page payloads.                                               |
| `src/notion/contractTables.ts`               | Fetches Notion databases and renders executor-style tables with priority sorting and fallback handling.              |
| `src/utils/http.ts` / `src/utils/parsing.ts` | Lightweight HTTP client (supports HTTP and local file paths) and TypeScript array parsing utilities.                 |
| `src/tagManager.ts`                          | Indexes snippet files once, tracks matching tag markers, and replaces the content between them.                      |
| `src/env.ts`                                 | Resolves environment-dependent paths such as the snippets directory.                                                 |
| `src/config/product-support-config.json`     | Describes where to read contract constants for each product (URLs, constant names, filters, overrides).              |
| `src/config/contracts-config.json`           | Source URLs for governance tables.                                                                                   |
| `src/chains/*.json`                          | Manually maintained chain metadata (titles, explorer links, faucets, notes).                                         |
| `src/check.ts`                               | Optional sanity check comparing docs data against the SDK.                                                           |

## How the Generator Works

1. **Collect chain data (`src/config.ts`)**  
   - Calls the Wormhole SDK’s `getContracts` function to list chains and fetch mainnet/testnet/devnet contract addresses.  
   - Augments each chain with metadata from `src/chains/<Chain>.json` (titles, explorers, notes).  
   - Persists any newly observed products back into the raw chain JSON so tables reflect both SDK data and manual overrides.

2. **Produce product matrices (`src/fetchAllProductChains.ts`)**  
   - Reads `config/product-support-config.json` and downloads the specified constants (typically raw GitHub files or local overrides).  
   - Optional allow-lists (`filterUrls`/`filterConsts`) enforce strict chain inclusion.  
   - Generates sorted JSON files in `src/generated/`, filling gaps where the SDK lacks product coverage.

3. **Render tables (`src/details.ts`, `src/governance.ts`, `src/notion/contractTables.ts`)**  
   - Converts the aggregated data into HTML snippets (contracts, chain IDs, supported networks, governance, etc.).
   - Executor and executor-adjacent tables pull from Notion databases when the accompanying environment variables are provided.

4. **Inject snippets (`src/tagManager.ts`)**  
   - Finds matching tag pairs across the snippets directory and replaces the interior with the rendered content.  
   - Warns if only one marker is found (e.g., missing closing `<!--TAG-->`).

Only files with actual content changes are rewritten, keeping diffs minimal.

## Common Tasks

### Rerun the automation
Follow the quick-start steps above (`npm run update` then `npm run generate`). After the generate step, inspect the console output:
- **“Updated X snippet files.”**: Indicates the run succeeded. Check the listed tags for details.
- **“Unmatched tag markers for TAG in …; skipping.”**: There is no matching closing marker in that snippet; add it before rerunning.

### Add or update a snippet section
1. Wrap the target area in your snippet with matching markers, e.g., `<!--MY_TAG--> ... <!--MY_TAG-->`.
2. In `src/index.ts`, call `tagManager.replace('MY_TAG', renderedContent)`.  
3. Run `npm run generate` to confirm the content is injected.

### Update chain metadata
1. Edit `src/chains/<Chain>.json`. Keep fields human-readable (`title`, faucet description, etc.).
2. Run `npm run generate`. The script may rewrite the file (two-space indentation) if the products have changed.
3. Review the updated snippets for the expected values.

### Add a product support table
1. Edit `src/config/product-support-config.json` and add a new entry:  
   - `product`: label for logs.  
   - `url` or `urls`: HTTP(S) or filesystem paths to the SDK TS files exporting the contract arrays.  
   - `consts`: constant names to read.  
   - Optional `filterUrls`/`filterConsts` for strict allow-lists, plus `excludeChains`, `manualAdd`, or `customChains`.  
   - `outputFile`: where to write the generated JSON (`./src/generated/<product>-support.json`).
2. Run `npm run generate`. Commit both the config change and the updated JSON/snippet files.

### Update governance sources
1. Modify the URLs inside `src/config/contracts-config.json`.
2. Ensure both `<!--GOVERNANCE_MAINNET-->` and `<!--GOVERNANCE_TESTNET-->` markers exist in `wormhole-docs/.snippets/text/products/reference/contract-addresses/governance.md`.
3. Run `npm run generate` and verify the governance table outputs (mainnet/testnet). Manual rows in the mainnet table are preserved.

### Create or modify helpers
- Share formatting helpers in `src/util.ts` or add new modules under `src/utils/`.  
- Update this README if you add new entrypoints/configs, so on-call teammates can locate them quickly.

## Troubleshooting

- **“Unmatched tag markers…”**  
  There is an opening `<!--TAG-->` without a matching closing marker. Add the closing marker or remove the tag.

- **Tag content didn’t change after running the script**  
  Ensure both markers exist and the tag name passed to `tagManager.replace` matches exactly. Also, confirm `DOCS_SNIPPETS_DIR` is pointing at the correct snippets folder.

- **Unexpected chains in a product table**  
  Revisit the `excludeChains`, `manualAdd`, and `filterConsts` settings for that product in `product-support-config.json`.

- **Runs feel slow**  
  Point `url`/`urls` to a local SDK checkout using `file://` or relative paths while developing. Network fetches remain available for CI or release runs.

- **JSON formatting churn**  
  The scripts rewrite JSON using two-space indentation. Keep manual edits consistent to reduce noise in diffs.

## Covering for the Owner

1. Follow the [quick-start](#quick-start) runbook. Resolve any warnings before moving on.
2. Review changes in both this directory and `wormhole-docs/.snippets/text`.
3. Open a PR with all modified files (scripts, configs, generated JSON, and snippets). Please mention any manual edits or new tags that have been introduced.
